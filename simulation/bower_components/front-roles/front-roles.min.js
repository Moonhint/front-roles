"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,r){function t(e){for(var r,t=e[0],n=e[e.length-1],s=1;t!==n&&(t=t.nextSibling);s++)(r||e[s]!==t)&&(r||(r=jqLite(slice.call(e,0,s))),r.push(t));return r||e}var n={},s=function(e){return e instanceof Array==!1&&null!==e&&"object"===(void 0===e?"undefined":_typeof(e))},o=function(e){return JSON.parse(JSON.stringify(e))};e.module("front-roles",[]),n=e.module("front-roles"),n.provider("FrontRoles",function(){var e={utilize_fetch:!0,encryption_secret:"secret",guest_abilities:["index","show"]},r=o(e);this.init_configs=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;t&&(r.utilize_fetch=t.utilize_fetch||e.utilize_fetch,r.encryption_secret=t.encryption_secret||e.encryption_secret,r.guest_abilities=t.guest_abilities||e.guest_abilities)},this.$get=function(){return{get_configs:function(){return r}}}}),n.config(function(){}),n.run(["FrontRolesLocalStorageService","FrontRolesResourceService","FrontRolesPermissionService",function(e,r,t){var n=e,s=n.get("front_roles.resources"),o=n.get("front_roles.permissions");s&&r.set_resources(s),o&&t.set_permissions(o)}]),n.service("FrontRolesResourceService",["FrontRoles","FrontRolesPermissionService","FrontRolesLocalStorageService",function(e,r,t){var n=t,s=(e.get_configs(),{server_url:"",current_user:{},params:{}}),i=o(s);this.set_resources=function(e){return i.server_url=e.server_url,i.current_user=e.current_user,i.params=e.params,n.set("front_roles.resources",i),i},this.get_resources=function(){return i},this.delete_resources=function(){i=o(s),n.unset("front_roles.resources")}}]),n.service("FrontRolesPermissionService",["$http","FrontRoles","FrontRolesLocalStorageService",function(e,r,t){var n=t,s=!0,o=r.get_configs().guest_abilities;this.permissions={},this.to_guess_state=function(){s=!0,this.permissions={},n.unset("front_roles.permissions")},this.set_permissions=function(e){this.permissions=e,n.set("front_roles.permissions",e),s=!1},this.get_permissions=function(){return this.permissions},this.fetch_permissions=function(r){var t=this;return new Promise(function(n,s){var i=r.params||{};r.current_user&&(i.user_id=r.current_user.id,i.username=r.current_user.username,i.user_email=r.current_user.email),e({url:r.server_url,method:"GET",params:i}).then(function(e){200==e.status?(t.set_permissions(e.data),n(e.data)):s(Error(e.statusText))},function(e){console.error("FrontRoles: Failed to fetch resources from server, fall back to default guest only privileges ["+o.toString()+"]"),s(e)})})},this.check_permission=function(e,r){var t=-1;if(s)t=o.indexOf(e);else{var n=this.permissions[e];n&&(t=n.indexOf(r))}return t!==-1}}]),n.factory("FrontRolesLocalStorageService",["FrontRoles",function(e){var t=e.get_configs(),n=r.AES;return{get:function(e){var s=void 0,o=localStorage.getItem(e);if(o){var i=n.decrypt(o.toString(),t.encryption_secret);s=JSON.parse(i.toString(r.enc.Utf8))}return s},set:function(e,r){var o=r;return s(o)&&(o=JSON.stringify(o)),o=n.encrypt(o,t.encryption_secret),localStorage.setItem(e,o)},unset:function(e){return localStorage.removeItem(e)}}}]),n.service("FrontRolesService",["FrontRoles","FrontRolesResourceService","FrontRolesPermissionService",function(e,r,t){var n=e.get_configs();this.after_login=function(e){var s=this;return new Promise(function(o,i){if(n.utilize_fetch){var c=r.set_resources(e);t.fetch_permissions(c).then(function(e){var r={};r.current_user=s.current_user(),r.permissions=e,o(r)},function(e){i(e)})}})},this.after_logout=function(e){r.delete_resources(),t.to_guess_state()},this.current_user=function(){return r.get_resources().current_user},this.user_can=function(e,r){return t.check_permission(e,r)}}]),n.directive("frCan",["$animate","$compile","FrontRolesPermissionService",function(e,r,n){return{priority:1,terminal:!0,transclude:"element",restrict:"A",link:function(s,o,i,c,u){var l,f,a,_=i.frCan.split(" "),m=_[0],p=_[1],v=(_[2],function(){return n.permissions});s.$watch(v,function(s){n.check_permission(m,p)?f||u(function(t,n){f=n,t[t.length++]=r.$$createComment("end Front Roles Can",i.frCan),l={clone:t},e.enter(t,o.parent(),o)}):(a&&(a.remove(),a=null),f&&(f.$destroy(),f=null),l&&(a=t(l.clone),e.leave(a).done(function(e){e!==!1&&(a=null)}),l=null))})}}}])}(angular,CryptoJS);